/* git@github.com:zhouzuchuan/Anchor.git */
!function(n,t,e){"use strict";function i(n){if(this===t)return new i(n);this.options={scrollDelay:300,closeScroll:!1};for(var e in n)this.options[e]=n[e];this.baseLine=0,this.collection=[],this._init()}function a(n){return/^\[[\S]+\]$/gi.test(n)?n.slice(1,-1):n}function l(n){return/^\./.test(n)?n.slice(1):n}function r(n){return Object.prototype.toString.call(n).slice(8,-1).toLowerCase()}function o(n){return null===n||"undefined"==typeof n||""===n||"undefined"===n}i.prototype={version:"1.0.0",_init:function(){var i=this,a=i._dealSelector(),l=[];i._dealBaseLine(),n.each(n("["+a.main+"]"),function(t,e){var r=i.collection,o=n(e).offset().top,s=n(e).outerHeight();r[t]={},r[t].key=n(e).attr(a.main),r[t].top=o,r[t].height=s,l.push(o,o+s,o-i.baseLine)}),i.mixin=[],i.mixin.push(Math.min.apply(null,l),Math.max.apply(null,l)),this.clickAndScrollSwitch=!0,o(n(t).on)?(n(e).delegate("["+a.btn+"]","click",i._onClickEvent()),n(t).bind({scroll:i._onScrollEvent()})):(n(e).on("click","["+a.btn+"]",i._onClickEvent()),n(t).on({scroll:i._onScrollEvent()})),i._scrollHandler()},_dealAnimation:function(){var t=this.options,e=t.scrollAnimation,i={enabled:!0,speed:500,easing:"swing",callback:n.noop};switch(r(e)){case"array":if(e.length<3)break;o(e[0])||(i.speed=e[0]),o(e[1])||(i.easing=e[1]),o(e[2])||(i.callback=e[2]);break;case"boolean":i.enabled=!1}return i},_dealBaseLine:function(){var e=this.options,i=n(t);if("number"===r(e.baseLine))this.baseLine=e.baseLine;else switch(e.baseLine){case"middle":this.baseLine=i.height()/2;break;case"top":this.baseLine=0;break;case"bottom":this.baseLine=i.height();break;default:this.baseLine=0}},_dealSelector:function(){var n=this.options,t=this._dealArray(n.selector);return t.btn=null===t.btn?"zzc-anchor-btn":t.btn,t.main=null===t.main?"zzc-anchor-main":t.main,t.btn===t.main&&(t.btn+="-btn",t.main+="-main"),{btn:t.btn,main:t.main}},_dealArray:function(){var t,e,i=arguments[0];if(!(0===arguments.length||arguments.length>1)){switch(r(i)){case"array":for(var o=0,s=i.length;s>o;o+=1){var c=n.trim(i[o]);i[o]=""===c?null:c}i.length>=2?(t=i[0],e=i[1]):t=e=i[0];break;case"string":t=e=n.trim(i);break;default:t=e=null}return{btn:l(a(t)),main:l(a(e))}}},_clickHandler:function(i){function a(){var e=arguments[0];c.enabled?n(b).stop().animate({scrollTop:e[f].top},c.speed,c.easing,function(){c.callback.call(l),l._timer=t.setTimeout(function(){l.clickAndScrollSwitch=!0},r.scrollDelay)}):(d.scrollTop=e[f].top,l._timer=t.setTimeout(function(){l.clickAndScrollSwitch=!0},r.scrollDelay))}var l=this,r=l.options,o=l._dealSelector(),s=l._dealArray(r.currentClass),c=l._dealAnimation(),u=n(i.currentTarget),h=n("["+o.main+"="+u.attr(o.btn)+"]"),m=u.attr(o.btn),d=e.documentElement||e.body,b=/webkit/.test(t.navigator.userAgent.toLowerCase())?"body":"html";if(!u.hasClass(s.btn)&&!h.hasClass(s.main)){t.clearTimeout(l._timer),this.clickAndScrollSwitch=!1;for(var f=0,p=l.collection.length;p>f;f+=1){var v=l.collection;v[f].key===m&&(a(v),l._removeClass(),l._addClass(f))}}},_scrollHandler:function(){var e=this,i=e.collection,a=n(t).scrollTop(),l=Math.max.apply(null,e.mixin),o=Math.min.apply(null,e.mixin),s=-1;if(!this.options.closeScroll&&this.clickAndScrollSwitch){for(var c=0,u=i.length;u>c;c+=1){var h=i[c].top;a+e.baseLine>=h&&(s=Math.max(s,h))}if((a>l||o>a)&&(s=-1,e._removeClass("noDid"),"function"===r(e.options.outArea)&&(e.options.outArea.apply(e,arguments),this.currentSelect="undefined")),s!==e.currentMaxRangValue){e.currentMaxRangValue=s;for(var m=0,d=i.length;d>m;m+=1){var b=i[m].top;b===e.currentMaxRangValue&&(e._removeClass(),e._addClass(m))}}}},_removeClass:function(){var t,e,i,a=this._dealSelector(),l=this.options,s=this._dealArray(l.currentClass);n("["+a.btn+"]").removeClass(s.btn),n("["+a.main+"]").removeClass(s.main),"noDid"!==arguments[0]&&"function"===r(l.currentDid)&&(o(this.currentSelect)||(t=this.collection[this.currentSelect].key,e=n("["+a.btn+"="+t+"]"),i=n("["+a.main+"="+t+"]")),l.currentDid.call(this,e,i))},_addClass:function(){var t=this._dealSelector(),e=this.options,i=this._dealArray(e.currentClass),a=this.collection[arguments[0]].key,l=n("["+t.btn+"="+a+"]"),o=n("["+t.main+"="+a+"]");this.currentSelect=arguments[0],"function"===r(e.currentWill)&&e.currentWill.call(this,l,o);for(var s in i)""!==i[s]&&n("["+t[s]+"="+a+"]").addClass(i[s])},_onClickEvent:function(){var n=this;return function(t){t.stopPropagation(),n._clickHandler.apply(n,arguments)}},_onScrollEvent:function(){var n=this,e=!0;return function(i){e&&(e=!1,t.setTimeout(function(){n._scrollHandler(),e=!0},n.options.scrollDelay))}}},t.Anchor=i}(jQuery,window,document);